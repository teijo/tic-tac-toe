<!DOCTYPE html>
<html>
  <head>
    <title>Tick-Tack-Toe</title>
  </head>
  <script src='jquery-1.7.1.min.js' type='text/javascript'></script>
  <style type='text/css'>
    body {
      background-color: #eeeeee; }
    
    canvas {
      background-color: white; }
    
    #terminal {
      background-color: #cccccc; }
    
    .wait {
      background-color: #990000; }
    
    .queued {
      background-color: #666666; }
    
    h1 span {
      color: white;
      background-color: #009900; }
  </style>
  <script type='text/javascript'>
    //<![CDATA[
      var GRID_LEN = 100
      var move = 0
      
      function dbg(data) {
        console.log(data)
        $('#terminal').prepend(data+'\n')
      }
      
      // return winner marker, true on tie and false if not over
      function isOver(g) {
                       //rows
        var vectors = [[[0,0],[0,1],[0,2]],
                       [[1,0],[1,1],[1,2]],
                       [[2,0],[2,1],[2,2]],
                       //cols
                       [[0,0],[1,0],[2,0]],
                       [[0,1],[1,1],[2,1]],
                       [[0,2],[1,2],[2,2]],
                       //diagonals
                       [[0,0],[1,1],[2,2]],
                       [[2,0],[1,1],[0,2]]]
      
        for (var i = 0; i < vectors.length; i++) {
          var v = vectors[i]
          var a = g[v[0][0]][v[0][1]]
          var b = g[v[1][0]][v[1][1]]
          var c = g[v[2][0]][v[2][1]]
          if ((a === 'x' || a === 'o') && a === b && a === c)
            return v
        }
      
        // full check, tie
        var over = true
        for (var i = 0; i < 3; i++)
          for (var j = 0; j < 3; j++)
            if (!g[i][j])
              over = false
      
        return over
      }
      
      if (!isOver(
        [['x','x','x'],
         [ 0 , 0 , 0 ],
         [ 0 , 0 , 0 ]]
        )) console.log('fail 1')
      
      if (!isOver(
        [[ 0 , 0 , 0 ],
         ['x','x','x'],
         [ 0 , 0 , 0 ]]
        )) console.log('fail 2')
      
      if (!isOver(
        [[ 0 , 0 , 0 ],
         [ 0 , 0 , 0 ],
         ['x','x','x']]
        )) console.log('fail 3')
      
      if (!isOver(
        [['x', 0 , 0 ],
         [ 0 ,'x', 0 ],
         [ 0 , 0 ,'x']]
        )) console.log('fail 4')
      
      if (!isOver(
        [[ 0 , 0 ,'x'],
         [ 0 ,'x', 0 ],
         ['x', 0 , 0 ]]
        )) console.log('fail 5')
      
      if (!isOver(
        [['x', 0 , 0 ],
         ['x', 0 , 0 ],
         ['x', 0 , 0 ]]
        )) console.log('fail 6')
      
      if (!isOver(
        [[ 0 ,'x', 0 ],
         [ 0 ,'x', 0 ],
         [ 0 ,'x', 0 ]]
        )) console.log('fail 7')
      
      if (!isOver(
        [[ 0 , 0 ,'x'],
         [ 0 , 0 ,'x'],
         [ 0 , 0 ,'x']]
        )) console.log('fail 8')
      
      if (!isOver(
        [['x','x','o'],
         ['o','o','x'],
         ['x','o','x']]
        )) console.log('fail 9')
      
      if (isOver(
        [[ 0 ,'x','o'],
         [ 0 ,'o', 0 ],
         [ 0 , 0 , 0 ]]
        )) console.log('fail 10')
      
      $(function() {
        var canvas = $('canvas')
        var ctx = canvas[0].getContext('2d')
      
        var lines = [[GRID_LEN*1, 20,         GRID_LEN,      GRID_LEN*3-20],
                     [GRID_LEN*2, 20,         GRID_LEN*2,    GRID_LEN*3-20],
                     [20,         GRID_LEN*1, GRID_LEN*3-20, GRID_LEN],
                     [20,         GRID_LEN*2, GRID_LEN*3-20, GRID_LEN*2]]
      
        ctx.lineWidth = 20
        ctx.strokeStyle = "#000"
        ctx.lineCap = "round"
      
      
        function insert(x, y, marker) {
          if (marker !== 'o' && marker !== 'x')
            return
          ctx.save()
          ctx.translate(x*GRID_LEN+50, y*GRID_LEN+50)
          ctx.beginPath()
          if (marker === 'x') {
            ctx.moveTo(-30, -30)
            ctx.lineTo( 30,  30)
            ctx.moveTo( 30, -30)
            ctx.lineTo(-30,  30)
          }
          else {
            ctx.arc(0, 0, 30, 0, Math.PI*2, true); 
          }
          ctx.stroke()
          ctx.restore()
        }
      
        function drawStrike(v) {
          var offset = (GRID_LEN/2)
          ctx.save()
          ctx.strokeStyle = '#F00'
          ctx.beginPath()
          ctx.moveTo(v[0][0]*GRID_LEN+offset, v[0][1]*GRID_LEN+offset)
          ctx.lineTo(v[2][0]*GRID_LEN+offset, v[2][1]*GRID_LEN+offset)
          ctx.stroke()
          ctx.restore()
        }
      
        function drawGame(state, vector) {
          ctx.clearRect(0, 0, canvas.width(), canvas.height())
          drawGrid()
          for (var y = 0; y < 3; y++)
            for (var x = 0; x < 3; x++)
              insert(x, y, state[x][y])
          if (typeof(vector) === 'object')
            drawStrike(vector)
        }
      
        function drawGrid() {
          $.each(lines, function(i, l) {
            ctx.beginPath()
            ctx.moveTo(l[0], l[1])
            ctx.lineTo(l[2], l[3])
            ctx.stroke()
          })
        }
      
        var sock = null
        if (typeof(WebSocket) == 'undefined')
          sock = MozWebSocket
        else
          sock = WebSocket
      
        dbg('Connecting ...')
        var ws = new sock("ws://localhost:10101")
      
        ws.onopen = function() {
          dbg('Connected.')
        }
      
        ws.onmessage = function (e) { 
            var data = JSON.parse(e.data)
            dbg(e.data)
            var vector = isOver(data.state)
            drawGame(data.state, vector)
            if (vector) {
              dbg("It's over")
              if (data.no < 2) {
                if (!data.move)
                  dbg("You won!")
                else
                  dbg("You lost")
              }
              if (data.no === 0)
                dbg("You'll spectate next.")
              else if (data.no === 1)
                dbg("You're playing! You start.")
              else if (data.no === 2)
                dbg("You're playing next! Opponent starts.")
              dbg(data.state)
            }
            else {
              var el = $('h1 span')
              el.toggleClass('queued', (data.players < 2 || data.no > 1))
              if (data.players < 2) {
                el.text('Waiting for more players')
              }
              else {
                if (data.no > 1) {
                  el.text('Spectating, queued '+(data.no-1)+'.')
                }
                else {
                  el.toggleClass('wait', !data.move)
                  if (data.move)
                    el.text('Your move')
                  else
                    el.text("Opponent's move")
                }
              }
            }
        }
        ws.onerror = function (e) { 
            dbg(e)
        }
        ws.onclose = function(e) { 
          dbg('Disconnected.')
        }
      
        canvas.click(function (e) {
          var obj = {x: parseInt(e.offsetX / GRID_LEN), 
                     y: parseInt(e.offsetY / GRID_LEN)}
          ws.send(JSON.stringify(obj))
        })
      })
    //]]>
  </script>
  <body></body>
  <h1>Tick-Tack-Toe <span></span></h1>
  <canvas height='300' width='300'></canvas>
  <pre id='terminal'></pre>
</html>
